#! /usr/bin/env sh

set -eu

script_dir=$(dirname "$0")
root_dir=$(cd "$script_dir/.." && pwd)

rm -rf "${root_dir}"/includes/core-phpunit/includes &&
  rm -rf "${root_dir}"/includes/core-phpunit/wordpress-develop &&
  mkdir -p "${root_dir}"/includes/core-phpunit &&
  cd "${root_dir}"/includes/core-phpunit &&
  git clone -n --depth=1 --filter=tree:0 https://github.com/WordPress/wordpress-develop &&
  cd wordpress-develop &&
  git sparse-checkout set --no-cone tests/phpunit/includes &&
  git checkout &&
  cd .. &&
  mv  wordpress-develop/tests/phpunit/includes ./includes &&
  rm -rf wordpress-develop &&
  cd "${root_dir}" &&
  # Run Rector to apply transformations (class renaming, method modifications, etc.)
  vendor/bin/rector process --config="${root_dir}/config/rector-core-phpunit.php" &&
  echo "Adding namespaces to test case files..." && 
  for file in testcase-ajax.php testcase-canonical.php testcase-rest-api.php testcase-rest-controller.php testcase-rest-post-type-controller.php testcase-xml.php testcase-xmlrpc.php; do
    sed -i.bak '1a\
\
namespace lucatume\\WPBrowser\\TestCase;\
\
' "${root_dir}/includes/core-phpunit/includes/${file}"
    rm -f "${root_dir}/includes/core-phpunit/includes/${file}.bak"
  done &&
  # Add use statement for WPTestCase to abstract-testcase.php
  sed -i.bak '2a\
use lucatume\\WPBrowser\\TestCase\\WPTestCase;\
\
' "${root_dir}/includes/core-phpunit/includes/abstract-testcase.php" &&
  rm -f "${root_dir}/includes/core-phpunit/includes/abstract-testcase.php.bak" &&
  # Run Rector again to prefix global class names (needs namespaces to be in place first)
  echo "Prefixing global class names..." &&
  vendor/bin/rector process --config="${root_dir}/config/rector-core-phpunit.php" &&
  # Run phpcbf to fix code style
  echo "Running phpcbf on core-phpunit files..." &&
  vendor/bin/phpcbf --standard=WordPress "${root_dir}/includes/core-phpunit" || true

